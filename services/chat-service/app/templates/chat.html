<div class="flex flex-col items-center">
    <h1>WebSocket Chat</h1>
    <h2>Your ID: <span id="ws-id"></span></h2>
    <form action="" onsubmit="sendMessage(event)">
        <input class="bg-green-300" type="text" id="messageText" autocomplete="off" />
        <input type="file" id="messageFile" />
        <input class="bg-green-300" type="text" id="roomIdInput" placeholder="Room ID" />
        <input class="bg-green-300" type="text" id="clientIdInput" placeholder="Client ID" />
        <button type="button" onclick="connectToWebSocket()">Connect</button>
        <button type="submit">Send</button>
    </form>
    <ul id="messages"></ul>
</div>
<script>
    let ws = null;
    function appendMessage(msg) {
        let messages = document.getElementById('messages');
        let message = document.createElement('li');
        let content = document.createTextNode(msg);
        message.appendChild(content);
        messages.appendChild(message);
    }

    function connectToWebSocket() {
        const roomId = document.getElementById("roomIdInput").value;
        const clientId = document.getElementById("clientIdInput").value;
        if (!roomId) {
            appendMessage("Room ID is required.");
            return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
            appendMessage("Already connected to a session.");
            return;
        }

        ws = new WebSocket(`ws://localhost:8000/ws/${roomId}/${clientId}`);
        ws.binaryType = "arraybuffer";

        ws.onopen = function () {
            appendMessage("Connected to the session.");
            getLastMessages(roomId); // Передайте ID комнаты
        };

        ws.onmessage = function (event) {
            console.log(event.data);
            appendMessage(event.data);
        };

        ws.onerror = function () {
            appendMessage("Connection error.");
        };
    }

    function sendMessage(event) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            appendMessage("Connection not found. Please connect first.");
            return;
        }

        let data = {};
        let input = document.getElementById("messageText");
        const message = input.value.trim(); // Trim to check for empty message
        let files = document.getElementById('messageFile').files;


        if (!message) {
            appendMessage("Message cannot be empty.");
        } else {
            let messageFiles = [
                {
                    "name": "Lab_7.docx",
                    "path_to_file": "storage/f3d34c2d-2b5b-417e-9699-c64bd652702e.docx"
                },
                {
                    "name": "Lab_6.docx",
                    "path_to_file": "storage/443cd59d-da6d-4c6a-be57-ae4276d63f60.docx"
                },
                {
                    "name": "Lab_5.docx",
                    "path_to_file": "storage/7b7537d5-b203-4b7b-aa58-d798cc3755a6.docx"
                }
            ];
            data['msg'] = message;
            data['files'] = messageFiles;
            ws.send(JSON.stringify(data));
        }
        input.value = '';
        event.preventDefault();
    }

    async function getLastMessages(roomId) { 
        if (ws && ws.readyState === WebSocket.OPEN) {
            const url = `http://localhost:8000/messages/last/${roomId}`; 
            const response = await fetch(url, {
                method: 'GET'
            });
            const messages = await response.json();
            appendMessage("Previous messages:");
            messages.forEach(msg => {
                appendMessage(msg.message);
            });
            appendMessage("New messages:");
        }
    }
</script>