services:
    - name: template-service
      # entrypoint: http://template-service:5000/
      entrypoint: http://127.0.0.1:8003/
      inject_token_in_swagger: True
    - name: medical-card-service
      # entrypoint: http://medical-card-service:5000/
      entrypoint: http://127.0.0.1:8002/
      inject_token_in_swagger: True
    - name: user-service
      # entrypoint: http://user-service:5000/
      entrypoint: http://127.0.0.1:8000/
      inject_token_in_swagger: True
    - name: health-diary-service
      # entrypoint: http://health-diary-service:5000/
      entrypoint: http://127.0.0.1:8004/
      inject_token_in_swagger: True
    - name: record-service
      # entrypoint: http://record-service:5000/
      entrypoint: http://127.0.0.1:8001/
      inject_token_in_swagger: True
    - name: chat-service
      # entrypoint: http://chat-service:5000/
      entrypoint: http://127.0.0.1:8005/
      inject_token_in_swagger: True
model: |
    [request_definition]
    r = sub, obj, act
    
    [policy_definition]
    p = sub_rule, obj, act
    
    [policy_effect]
    e = some(where (p.eft == allow))
    
    [matchers]
    m = regexMatch(r.obj.resource, p.obj) && regexMatch(r.act, p.act) && eval(p.sub_rule)
policies:
  # template-service
    # templates
    - service: template-service
      rule: r.sub.group_id == 1
      resource: ^/templates(/\d+)?$
      methods: (GET)|(POST)|(PUT)|(DELETE)
    - service: template-service
      rule: r.sub.group_id == 2
      resource: ^/templates(/\d+)?$
      methods: (GET)
    - service: template-service
      rule: r.sub.group_id == 3
      resource: ^/templates/\d+$
      methods: (GET)

  # medical-card-service
    # cards
    - service: medical-card-service
      rule: r.sub.group_id == 1
      resource: ^/cards(/\d+)?$
      methods: (GET)|(POST)|(PATCH)|(DELETE)
    - service: medical-card-service
      rule: r.sub.group_id == 2
      resource: ^/cards(/\d+)?$
      methods: (GET)
    - service: medical-card-service
      rule: r.sub.group_id == 3 && r.obj.params.user_id == r.sub.sub
      resource: ^/cards/me/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      resource_pattern: /cards/me/(?P<user_id>.*)
      methods: (GET)
    - service: medical-card-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3
      resource: /family_status
      methods: GET
    - service: medical-card-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3
      resource: /education
      methods: GET
    - service: medical-card-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3
      resource: /busyness
      methods: GET
    
    # pages
    - service: medical-card-service
      rule: r.sub.group_id == 2
      resource: ^/pages(/.*)?$
      methods: (GET)|(POST)
    - service: medical-card-service
      rule: r.sub.group_id == 2 && r.obj.params.page_id in r.sub.available_pages_of_medical_card
      resource: ^/pages/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      resource_pattern: /pages/(?P<page_id>.*)
      methods: (PUT)|(DELETE)
    - service: medical-card-service
      rule: r.sub.group_id == 3
      resource: ^/pages/card.*$
      methods: (GET)
  
  # user-service
    # auth
    - service: user-service
      resource: /auth/jwt/login
      methods: (POST)
      white_list: true
    - service: user-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3 
      resource: /auth/jwt/logout
      methods: (POST)
    - service: user-service
      resource: /auth/register
      methods: (POST)
      white_list: true
    - service: user-service
      resource: /auth/forgot-pasword
      methods: (POST)
      white_list: true
    - service: user-service
      resource: /auth/reset-password
      methods: (POST)
      white_list: true
    - service: user-service
      resource: /auth/request-verify-token
      methods: (POST)
      white_list: true
    - service: user-service
      resource: /auth/verify
      methods: (POST)
      white_list: true

    # users
    - service: user-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3
      resource: ^/users/me.*$
      methods: (GET)|(PATCH)|(DELETE)
    - service: user-service
      rule: r.sub.group_id == 1
      resource: ^/users/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      methods: (GET)
    - service: user-service
      rule: r.sub.group_id == 1
      resource: ^/users/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}.*$
      methods: (PATCH)|(DELETE)
    - service: user-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3
      resource: ^/users/user/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/summary$
      methods: (GET)
    - service: user-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2
      resource: /users/all/summary
      methods: (GET)
    - service: user-service
      resource: ^/users/specialization/\d+$
      methods: (GET)
      white_list: true
    
    # storage
    - service: user-service
      resource: ^/storage.*$
      methods: (GET)
      white_list: true


    # specialization
    - service: user-service
      resource: ^/specializations.*$
      methods: (GET)
      white_list: true

    # confirm_code
    - service: user-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3
      resource: ^/send_confirm_code$
      methods: (POST)
    - service: user-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3
      resource: ^/check_confirm_code$
      methods: (POST)
  
  # health-diary-service
    - service: health-diary-service
      rule: r.sub.group_id == 3
      resource: /diaries/user/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      methods: (POST)
    - service: health-diary-service
      rule: r.sub.group_id == 3
      resource: /diaries/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      methods: (GET)|(PATCH)|(DELETE)
    - service: health-diary-service
      rule: r.sub.group_id == 2 || r.sub.group_id == 3
      resource: /diaries/user/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      methods: (GET)


  # record-service
    # records
    - service: record-service
      rule: r.sub.group_id == 1
      resource: ^/records.*$
      methods: (GET)|(DELETE)
    - service: record-service
      rule: r.sub.group_id == 2
      resource: ^/records/doctor/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      methods: (GET)
    - service: record-service
      rule: r.sub.group_id == 3
      resource: ^/records$
      methods: (POST)
    - service: record-service
      rule: r.sub.group_id == 3
      resource: ^/records/user/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
      methods: (GET)

    # schedules
    - service: record-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 3
      resource: ^/schedules.*$
      methods: (GET)|(POST)|(PATCH)|(DELETE)
    # - service: record-service
    #   rule: r.sub.group_id == 3
    #   resource: ^/schedules/doctor/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/available_dates$
    #   methods: (GET)
    # - service: record-service
    #   rule: r.sub.group_id == 1
    #   resource: ^/schedules/doctor/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$
    #   methods: (GET)

  # chat-service
    - service: chat-service
      rule: r.sub.group_id == 1 || r.sub.group_id == 2 || r.sub.group_id == 3 
      resource: ^/meetings.*$
      methods: (GET)|(POST)